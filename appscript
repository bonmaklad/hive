function doGet(e) {
  const email = e.parameter.email;
  if (!email) {
    return output({ error: "No email param" });
  }

  const sheet = SpreadsheetApp.getActiveSpreadsheet().getSheetByName("RSVP");
  const data = sheet.getDataRange().getValues();
  const headers = data.shift();
  const emailIndex = headers.indexOf("email");

  const row = data.find(r => r[emailIndex] === email);
  if (!row) {
    return output({ status: "NOT_INVITED" });
  }

  const statusIndex = headers.indexOf("status");
  const guestCountIndex = headers.indexOf("guest_count");
  const guest1Index = headers.indexOf("guest_1_name");
  const guest2Index = headers.indexOf("guest_2_name");
  const guest3Index = headers.indexOf("guest_3_name");

  return output({
    status: row[statusIndex],
    guestCount: row[guestCountIndex],
    guest_1: row[guest1Index],
    guest_2: row[guest2Index],
    guest_3: row[guest3Index]
  });
}

function doPost(e) {
  const body = JSON.parse(e.postData.contents);
  const { email, guestCount, guestNames } = body;

  const sheet = SpreadsheetApp.getActiveSpreadsheet().getSheetByName("RSVP");
  const data = sheet.getDataRange().getValues();
  const headers = data.shift();
  const emailIndex = headers.indexOf("email");

  const rowIndex = data.findIndex(r => r[emailIndex] === email);
  if (rowIndex === -1) {
    return output({ error: "NOT_INVITED" });
  }

  const realRow = rowIndex + 2; // account for header row

  sheet.getRange(realRow, headers.indexOf("status") + 1).setValue("YES");
  sheet.getRange(realRow, headers.indexOf("guest_count") + 1).setValue(guestCount);
  sheet.getRange(realRow, headers.indexOf("guest_1_name") + 1).setValue(guestNames[0] || "");
  sheet.getRange(realRow, headers.indexOf("guest_2_name") + 1).setValue(guestNames[1] || "");
  sheet.getRange(realRow, headers.indexOf("guest_3_name") + 1).setValue(guestNames[2] || "");
  sheet.getRange(realRow, headers.indexOf("timestamp") + 1).setValue(new Date());

  return output({ status: "ok" });
}

function output(obj) {
  return ContentService.createTextOutput(JSON.stringify(obj))
    .setMimeType(ContentService.MimeType.JSON);
}

